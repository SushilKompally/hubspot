version: 2

models:
  - name: fact_deal_activity
    description: "Fact table linking HubSpot deals to engagement activities by date."
    config:
      contract:
        enforced: true
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [deal_key, activity_key, date_key]

    columns:
      - name: activity_unique_key
        description: "Surrogate PK for the row (hash of deal_key, activity_key, date_key)."
        data_type: varchar
        tests:
          - not_null
          - unique

      - name: deal_key
        description: "Natural key of the deal (hs_deal_id from silver_deals)."
        data_type: varchar
        tests:
          - not_null
          # If you have a dim_deal with a surrogate key, update to reference that model/column.
          # For now, this references the silver_deals natural key.
          - relationships:
              to: ref('silver_deals')
              field: hs_deal_id

      - name: activity_key
        description: "Engagement key referencing fact_engagement."
        data_type: number
        tests:
          - not_null
          - relationships:
              to: ref('fact_engagement')
              field: engagement_key

      - name: date_key
        description: "Foreign key to dim_date."
        data_type: number
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key

      - name: last_modified_date
        description: "Last modified timestamp of the underlying deal record (used for incremental filter)."
        data_type: timestamp_ntz
